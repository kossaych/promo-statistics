<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ISI Statistics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'VT323', monospace;
            background-color: #000000;
        }

        .terminal-container {
            width: 95%;
            max-width: 1200px;
            margin: 1rem auto;
            background-color: #000000;
            border: 1px solid #00ff00;
            padding: 1rem;
            overflow-x: auto;
        }

        .prompt::before {
            content: 'dev@isi-dashboard:~$ ';
            color: #00ff00;
            margin-right: 0.5rem;
        }

        .cli-table {
            border-collapse: collapse;
            width: 100%;
        }

        .cli-table th, .cli-table td {
            padding: 0.2rem 0.5rem;
            text-align: left; 
            border-bottom: 1px solid #00ff00;
        }


        .cli-table th { 
            color: white; 
        }
        
        .chart-container {
            height: 400px;
            width: 100%;
            background-color: transparent;
        }
        

        /* Add these new mobile-friendly styles */
        @media (max-width: 768px) {
            .terminal-container {
                width: 98%;
                padding: 0.5rem;
                margin: 0.5rem auto;
            }

            .text-3xl {
                font-size: 1.5rem;
            }

            .text-xl {
                font-size: 1.125rem;
            }

            .cli-table {
                font-size: 0.875rem;
            }

            .cli-table th, .cli-table td {
                padding: 0.1rem 0.2rem;
            }

            .chart-container {
                height: 300px;
            }

            .responsive-table-wrapper {
                position: relative;
                margin-bottom: 1rem;
            }

            .responsive-table-wrapper::after {
                content: '‚Üê Scroll ‚Üí';
                position: absolute;
                bottom: -20px;
                left: 0;
                width: 100%;
                text-align: center;
                color: #aaffaa;
                font-size: 0.875rem;
            }
        }

    </style>
</head>
<body>
    <div class="terminal-container">
        <!-- Header -->
        <div class="text-3xl font-normal mb-8 text-center text-[#800080] border-2 border-dashed border-[#006400] py-2">
            <p>ISI STATISTICS DASHBOARD</p>
        </div>

        <p class="text-xl">
            <span class="prompt"></span>
            <span class="text-[#aaffaa]">stats --view-all</span>
        </p>

        <!-- Stats Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-8 text-[#aaffaa]">
            <div class="border border-[#00ff00] p-4">
                <p>üìö Students: <strong>{{ students|length }}</strong></p>
                <p>üìñ Subjects: <strong>{{ subjects|length }}</strong></p>
                
            </div>
            <div class="border border-[#00ff00] p-4">
                <p>‚úÖ Passed: <strong>{{ studentspassed }}</strong></p>
                <p>‚ùå Control: <strong>{{ studentscontrole }}</strong></p>
                
            </div>
            <div class="border border-[#00ff00] p-4">
                <p>üìä Class Average: <strong>{{ moy_gen_all }}</strong></p>
            </div>
        </div>


        
<!-- Search Section -->
<div class="mb-4">
    <p class="text-xl text-[#aaffaa] mb-4">
        <span class="prompt"></span>
        <span>find --student</span>
    </p>
    <form id="studentRedirectForm" action="" method="GET" onsubmit="return redirectToStudentPage(event)" 
          class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
        <input 
            type="text" 
            id="studentIdInput" 
            placeholder="Enter student CIN" 
            required
            class="p-2 bg-black text-[#aaffaa] border border-[#00ff00] focus:outline-none w-full sm:w-[250px]"
        />
        <button 
            type="submit" 
            class="px-4 py-2 text-sm bg-black text-[#aaffaa] border border-[#00ff00] hover:bg-[#00ff00] hover:text-black transition-colors"
        >
            Search
        </button>
    </form>
</div> 
        
        <!-- Students Table -->
        <div class="mb-8">
            <p class="text-xl text-[#aaffaa] mb-4">
                <span class="prompt"></span>
                <span>list --top-students</span>
            </p>
            <form id="compareForm" action="/compare-students" method="GET">
                <button 
                    type="submit" 
                    id="compareButton"
                    disabled
                    class="  px-4 py-2 bg-black text-[#aaffaa] border border-[#00ff00] hover:bg-[#00ff00] hover:text-black transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Compare Selected Students
                </button>
                <span id="selectedCount" class="text-[#aaffaa] ml-2">(0 students selected)</span>

                <div class="responsive-table-wrapper overflow-x-auto">
                    <table class="cli-table min-w-[800px]">
                        <thead>
                            <tr>
                                <th>Select for comparission</th>
                                <th>Rank</th>
                                <th>Name</th>
                                <th>First Name</th>
                                <th>Sem 1</th>
                                <th>Sem 2</th>
                                <th>Average</th>
                                <th>Score A</th>
                                <th>Score E ISSAT</th>
                                <th>Score ML</th>
                                <th>Score S</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                              {% if student.rang <= 5 %}
                                <tr style="color: {% cycle '#ff00ff' '#ffff00' '#ff0000' '#00e5e5' %}"  id="{{ student.id }}">
                                  <td>
                                    <label class="cursor-pointer select-none flex items-center">
                                      <input 
                                        type="checkbox" 
                                        name="selected_students" 
                                        value="{{ student.id }}" 
                                        class="peer hidden"
                                        onchange="updateSelectedCount()"
                                      >
                                      <span class="font-mono text-lg peer-checked:hidden">[ ]</span>
                                      <span class="font-mono text-lg hidden peer-checked:inline">[X]</span>
                                    </label>
                                  </td>

                                  <td >{{ student.rang }}</td>
                                  <td  >{{ student.nom }}</td>
                                  <td  >{{ student.prenom }}</td>
                                  <td  >{{ student.moy_gen1 }}</td>
                                  <td  >{{ student.moy_gen2 }}</td>
                                  <td  >{{ student.moy_gen }}</td>
                                  <td  >{{ student.A }}</td>
                                  <td  >{{ student.E }}</td> 
                                  <td  >{{ student.ML }}</td>
                                  <td  >{{ student.S }}</td> 
                                  <td>
                                    <button 
                                      type="button"
                                      onclick="window.location.href='/students/{{student.id}}'" 
                                      class="px-2  bg-black text-[#aaffaa] border border-[#00ff00] hover:bg-[#00ff00] hover:text-black transition-colors disabled:opacity-50 disabled:cursor-not-allowed"       
                                    >
                                      View Details
                                    </button>
                                  </td>
                                </tr>
                              {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>

        <!-- JSON data for charts -->
        <div id="students" style="display: none;">{{ students|json_script }}</div>
        <div id="subjects" style="display: none;">{{ subjects|json_script }}</div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-8">
            <div class="border-2 border-[#00ff00] p-2 md:p-4">
                <p class="text-xl text-[#aaffaa] mb-4">
                    <span class="prompt"></span>
                    <span>chart --grade-distribution</span>
                </p>
                <div class="chart-container">
                    <canvas id="gradeHistogram"></canvas>
                </div>
            </div>
            <div class="border-2 border-[#00ff00] p-2 md:p-4">
                <p class="text-xl text-[#aaffaa] mb-4">
                    <span class="prompt"></span>
                    <span>chart --subject-averages</span>
                </p>
                <div class="chart-container">
                    <canvas id="subjectAverages"></canvas>
                </div>
            </div>
        </div>

        <p class="mt-8 text-sm">
            <span class="text-[#aaffaa]">‚ö° Hack The Mainframe ~ made by Koussay Chemingui</span>
        </p>
    </div>

    <!-- JavaScript for Charts -->
    <script>
        const students = JSON.parse(document.getElementById('students').textContent);
        const subjects = JSON.parse(document.getElementById('subjects').textContent);

        const gradeBins = Array.from({ length: 21 }, (_, i) => i);
        const gradeCounts = new Array(20).fill(0);

        students.forEach(student => {
          const grade = student.moy_gen;
          const binIndex = Math.floor(grade);
          if (binIndex >= 0 && binIndex < 20) gradeCounts[binIndex]++;
        });

        // Update chart configurations
        const chartConfig = {
            plugins: {
                legend: {
                    labels: { 
                        color: '#aaffaa',
                        boxWidth: 20,
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: { color: 'rgba(0, 255, 0, 0.1)' },
                    ticks: { 
                        color: '#aaffaa',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        }
                    }
                },
                x: {
                    grid: { color: 'rgba(0, 255, 0, 0.1)' },
                    ticks: { 
                        color: '#aaffaa',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        }
                    }
                }
            },
            maintainAspectRatio: false,
            responsive: true
        };

        new Chart(document.getElementById('gradeHistogram'), {
          type: 'bar',
          data: {
            labels: gradeBins.slice(0, -1).map((v, i) => `${v}-${v + 1}`),
            datasets: [{
              label: 'Number of Students',
              data: gradeCounts,
              backgroundColor: "#000000",
              borderColor: "#8A2BE2",
              borderWidth: 1,
              borderRadius: 0 
            }]
          },
          options: {
            ...chartConfig,
            responsive: true
          }
        });

        const subjectAverages = subjects.map(subject =>
          students.reduce((sum, student) => sum + (student[subject] || 0), 0) / students.length
        );

        new Chart(document.getElementById('subjectAverages'), {
          type: 'bar',
          data: {
            labels: subjects,
            datasets: [{
              label: 'Average Score',
              data: subjectAverages,  

              backgroundColor: "#000000",
              borderColor: "#8A2BE2",
              borderWidth: 1,
              borderRadius: 0 
            }]
          },
          options: {
            ...chartConfig,
            responsive: true
          }
        });


        function redirectToStudentPage(event) {
          event.preventDefault();
          const id = document.getElementById('studentIdInput').value.trim();
          if (!id) {
            alert('Please enter a student ID.');
            return false;
          }
            // Adjust the URL below to match your actual route pattern for student stats
            window.location.href = `/students/${encodeURIComponent(id)}`;
            return false; // prevent default form submission
        }
        function updateSelectedCount() {
  const selectedCheckboxes = document.querySelectorAll('input[name="selected_students"]:checked');
  const compareButton = document.getElementById('compareButton');
  const selectedCount = document.getElementById('selectedCount');
  const count = selectedCheckboxes.length;

  selectedCount.textContent = `(${count} students selected)`;
  
  // Enable compare button if at least 2 students are selected
  if (count >= 2) {
    compareButton.disabled = false;
    compareButton.style.opacity = '1';
  } else {
    compareButton.disabled = true;
    compareButton.style.opacity = '0.6';
  }
}

document.getElementById('compareForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const selectedCheckboxes = document.querySelectorAll('input[name="selected_students"]:checked');
  if (selectedCheckboxes.length < 2) {
    alert('Please select at least 2 students to compare');
    return;
  }

  const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
  const queryString = selectedIds.map(id => `student_ids=${id}`).join('&');
  window.location.href = `/compare-students?${queryString}`;
});
    </script>
</body>
</html>

